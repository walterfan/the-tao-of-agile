

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Java 测试实战 &mdash; The Tao of Agile 1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=e536ea0c" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=29a6c3e3"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script>let toggleHintShow = 'Click to show';</script>
      <script>let toggleHintHide = 'Click to hide';</script>
      <script>let toggleOpenOnPrint = 'true';</script>
      <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4. Agile DevOps" href="../4.devops/index.html" />
    <link rel="prev" title="Test Mock" href="test_mock.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            The Tao of Agile
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../1.method/index.html">1. Agile Method</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2.architecture/index.html">2. Agile Architecture</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">3. Agile Programming</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">敏捷架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="graph_model.html">Property Graph Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="rpc_rest_graphql.html">RPC, REST, 还是 GraphQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="pattern.html">Pattern</a></li>
<li class="toctree-l2"><a class="reference internal" href="clean_code.html">Clean Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="good_code.html">什么是好代码</a></li>
<li class="toctree-l2"><a class="reference internal" href="micro-profile-config.html">MicroProfile Config</a></li>
<li class="toctree-l2"><a class="reference internal" href="micro-profile-fault-tolerance.html">MicroProfile Fault Tolerance</a></li>
<li class="toctree-l2"><a class="reference internal" href="test_mock.html">Test Mock</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Java 测试实战</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">测试用例的组织</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">单元测试</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">Java 单元测试</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">数据驱动测试</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id5">编写注解来自动生成测试用例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">参考资料</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../4.devops/index.html">4. Agile DevOps</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Tao of Agile</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">3. Agile Programming</a></li>
      <li class="breadcrumb-item active">Java 测试实战</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/3.program/test_in_java.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="java">
<h1>Java 测试实战<a class="headerlink" href="#java" title="Link to this heading"></a></h1>
<section id="id1">
<h2>测试用例的组织<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<p>首先要胸有成竹, 哪些测试应该做, 在[微服务实战测试之理论篇] 中已提过一些指导原则, 我们要根据这些原则, 结合要测试的特性, 把所有有可能出错的地方覆盖到, 防患于未然.</p>
<p>借用 Cucumber 中的定义的 Gherkin 语法, 一个特性 Feature 有若干个场景 Scenario
而每个场景都必须有独立的意义, 并且不依赖任何其他场景而独立运行.</p>
<p>以表格的形式组织测试用例是比较常见的做法</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>特性Feature</p></th>
<th class="head"><p>场景Scenario</p></th>
<th class="head"><p>给定Given</p></th>
<th class="head"><p>事件 When</p></th>
<th class="head"><p>结果 Then</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>作为系统用户, 我想在任务即将截止设置三次提醒来通知我, 从而我能即时采取措施而不至于超时</p></td>
<td><p>今天周一, 我要在周日前交稿</p></td>
<td><p>截止日期前一天要有邮件提醒</p></td>
<td><p>周六到了</p></td>
<td><p>收到提醒邮件</p></td>
</tr>
</tbody>
</table>
<p>也可以用 wiki 或其他文件格式来存储用例, 推荐用格式化, 易解析的格式化文本文件, 比如 json.</p>
<p>结构层次为 1) Test Suite – 2) Test Case – 3) Test Steps(Given, When, Then)</p>
<p>例如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;testsuites&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;login_module_test&quot;</span><span class="p">,</span>
      <span class="s2">&quot;testcases&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;login_by_phone_step1&quot;</span><span class="p">,</span>
          <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="s2">&quot;login&quot;</span><span class="p">,</span>
          <span class="s2">&quot;scenario&quot;</span><span class="p">:</span> <span class="s2">&quot;login by mobile phone&quot;</span><span class="p">,</span>
          <span class="s2">&quot;given&quot;</span><span class="p">:</span> <span class="s2">&quot;input mobile phone number&quot;</span><span class="p">,</span>
          <span class="s2">&quot;when&quot;</span><span class="p">:</span> <span class="s2">&quot;submit&quot;</span><span class="p">,</span>
          <span class="s2">&quot;then&quot;</span><span class="p">:</span> <span class="s2">&quot;send a sms for authenticate code&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;login_by_phone_step2&quot;</span><span class="p">,</span>
          <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="s2">&quot;login&quot;</span><span class="p">,</span>
          <span class="s2">&quot;scenario&quot;</span><span class="p">:</span> <span class="s2">&quot;login by mobile phone&quot;</span><span class="p">,</span>
          <span class="s2">&quot;given&quot;</span><span class="p">:</span> <span class="s2">&quot;input mobile phone number and authenticate code&quot;</span><span class="p">,</span>
          <span class="s2">&quot;when&quot;</span><span class="p">:</span> <span class="s2">&quot;submit&quot;</span><span class="p">,</span>
          <span class="s2">&quot;then&quot;</span><span class="p">:</span> <span class="s2">&quot;redirect the user&#39;s home paeg&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;login_by_error_password&quot;</span><span class="p">,</span>
          <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="s2">&quot;login&quot;</span><span class="p">,</span>
          <span class="s2">&quot;scenario&quot;</span><span class="p">:</span> <span class="s2">&quot;login by username and password&quot;</span><span class="p">,</span>
          <span class="s2">&quot;given&quot;</span><span class="p">:</span> <span class="s2">&quot;input username, password, and captcha&quot;</span><span class="p">,</span>
          <span class="s2">&quot;when&quot;</span><span class="p">:</span> <span class="s2">&quot;submit&quot;</span><span class="p">,</span>
          <span class="s2">&quot;then&quot;</span><span class="p">:</span> <span class="s2">&quot;dispatch login failure message: you inputed improper username or password&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>也可以自己写一个注解来自己生成测试用例, 我们在文末给出一个例子</p>
</section>
<section id="id2">
<h2>单元测试<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<p>在微服务实战测试之理论篇中我们提到测试的分类和测试金字塔, 单元测试是基石, 做好单元是首要的测试工作, 以我熟悉的几种语言为例</p>
<p>测试的写法就四步 SEVT (TVes 许多电视倒过来)</p>
<ol class="arabic simple">
<li><p>准备 setup</p></li>
<li><p>执行 exercise</p></li>
<li><p>验证 verify</p></li>
<li><p>清理 teardown</p></li>
</ol>
<p>简单测试可以忽略1) 和 4) 步</p>
<section id="id3">
<h3>Java 单元测试<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<p>哪些库我们可以用呢</p>
<p>如果你使用 spring-boot-starter-test ‘Starter’ (test scope),  你会发现它所提供的下列库:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://junit.org/">JUnit</a> — The de-facto standard for unit testing Java applications.</p></li>
<li><p><a class="reference external" href="http://docs.spring.io/spring/docs/5.0.0.RC3/spring-framework-reference/testing.html#integration-testing">Spring Test</a> &amp; Spring Boot Test — Utilities and integration test support for Spring Boot applications.</p></li>
<li><p><a class="reference external" href="http://joel-costigliola.github.io/assertj/">AssertJ</a> — A fluent assertion library.</p></li>
<li><p><a class="reference external" href="http://hamcrest.org/JavaHamcrest/">Hamcrest</a> — A library of matcher objects (also known as constraints or predicates).</p></li>
<li><p><a class="reference external" href="http://mockito.org/">Mockito</a> — A Java mocking framework.</p></li>
<li><p><a class="reference external" href="https://github.com/skyscreamer/JSONassert">JSONassert</a> — An assertion library for JSON.</p></li>
<li><p><a class="reference external" href="https://github.com/jayway/JsonPath">JsonPath</a> — XPath for JSON.</p></li>
</ul>
<p>单元测试框架的鼻祖是 junit, 为什么不用 junit 呢? TestNG 有什么独到之处可以后来居上呢? 原因就在于 testng 更为强大的功能, 如 &#64;Test 注解, 可以指定 testcase 的依赖关系, 调用次数, 调用顺序, 超时时间, 并发线程数以及期望的异常, 考虑得非常周到.</p>
<p>当然, 这只是个人喜好, Junit 新版本也多了很多改进.</p>
<p>举个例子, Fibonacci 数列大家很熟悉, 用 Java8 的 stream, lambda 的新写法比老的写法酷很多, 代码行数少了许多.</p>
<p>老写法</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">fibonacci1</span><span class="p">(</span><span class="nb">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
        <span class="nb">int</span> <span class="n">n0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n2</span><span class="p">;</span>
        <span class="nb">list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n0</span><span class="p">);</span>
        <span class="nb">list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n1</span><span class="p">);</span>

        <span class="k">for</span><span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="n">n1</span> <span class="o">+</span> <span class="n">n0</span><span class="p">;</span>
            <span class="n">n0</span> <span class="o">=</span> <span class="n">n1</span><span class="p">;</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="n">n2</span><span class="p">;</span>
            <span class="nb">list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n2</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>新写法</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">fibonacci2</span><span class="p">(</span><span class="nb">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Stream</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">new</span> <span class="nb">int</span><span class="p">[]{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">new</span> <span class="nb">int</span><span class="p">[]{</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
                <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="o">.</span><span class="n">toList</span><span class="p">());</span>
    <span class="p">}</span>

</pre></div>
</div>
<p>然而性能如何呢? 写个单元测试吧</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">walterfan</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">java8</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.google.common.base.Stopwatch</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.slf4j.Logger</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.testng.annotations.AfterClass</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.testng.annotations.BeforeClass</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.testng.annotations.DataProvider</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.testng.annotations.Test</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.TreeMap</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ConcurrentSkipListMap</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.TimeUnit</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.function.Function</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collector</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collectors</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Stream</span><span class="p">;</span>

<span class="o">/**</span>
 <span class="o">*</span> <span class="n">Created</span> <span class="n">by</span> <span class="n">walter</span> <span class="n">on</span> <span class="mi">24</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mf">2017.</span>
 <span class="o">*</span> <span class="nd">@see</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">testng</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">documentation</span><span class="o">-</span><span class="n">main</span><span class="o">.</span><span class="n">html</span>
 <span class="o">*/</span>
<span class="n">public</span> <span class="k">class</span><span class="w"> </span><span class="nc">LambdaPerfTest</span> <span class="p">{</span>
    <span class="n">private</span> <span class="n">static</span> <span class="n">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">LambdaPerfTest</span><span class="o">.</span><span class="n">class</span><span class="p">);</span>

    <span class="n">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">oldFibonacciResults</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">newFibonacciResults</span><span class="p">;</span>


    <span class="nd">@BeforeClass</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">oldFibonacciResults</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ConcurrentSkipListMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="n">newFibonacciResults</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ConcurrentSkipListMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@AfterClass</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">summarize</span><span class="p">()</span> <span class="p">{</span>
        <span class="nb">int</span> <span class="n">rounds</span> <span class="o">=</span> <span class="n">oldFibonacciResults</span><span class="o">.</span><span class="n">size</span><span class="p">();</span>

        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;--- old vs. new ---&quot;</span><span class="p">);</span>
        <span class="n">oldFibonacciResults</span><span class="o">.</span><span class="n">forEach</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s2">&quot; vs. &quot;</span> <span class="o">+</span> <span class="n">newFibonacciResults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
           <span class="o">//</span><span class="n">TODO</span><span class="p">:</span> <span class="n">add</span> <span class="k">assert</span> <span class="k">for</span> <span class="n">performance</span> <span class="n">compare</span>
        <span class="p">});</span>

    <span class="p">}</span>

    <span class="n">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">fibonacci1</span><span class="p">(</span><span class="nb">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
        <span class="nb">int</span> <span class="n">n0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n2</span><span class="p">;</span>
        <span class="nb">list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n0</span><span class="p">);</span>
        <span class="nb">list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n1</span><span class="p">);</span>

        <span class="k">for</span><span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="n">n1</span> <span class="o">+</span> <span class="n">n0</span><span class="p">;</span>
            <span class="n">n0</span> <span class="o">=</span> <span class="n">n1</span><span class="p">;</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="n">n2</span><span class="p">;</span>
            <span class="nb">list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n2</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">fibonacci2</span><span class="p">(</span><span class="nb">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Stream</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">new</span> <span class="nb">int</span><span class="p">[]{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">new</span> <span class="nb">int</span><span class="p">[]{</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
                <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="o">.</span><span class="n">toList</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="nd">@DataProvider</span>
    <span class="n">public</span> <span class="n">Object</span><span class="p">[][]</span> <span class="n">getFibonacciSize</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">new</span> <span class="n">Object</span><span class="p">[][]{</span>
                <span class="p">{</span><span class="mi">10</span><span class="p">},</span>
                <span class="p">{</span><span class="mi">50</span><span class="p">},</span>
                <span class="p">{</span><span class="mi">100</span><span class="p">},</span>
                <span class="p">{</span><span class="mi">1000</span><span class="p">},</span>
                <span class="p">{</span><span class="mi">10000</span><span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="nd">@Test</span><span class="p">(</span><span class="n">dataProvider</span> <span class="o">=</span> <span class="s2">&quot;getFibonacciSize&quot;</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;old fibonacci&quot;</span><span class="p">,</span> <span class="n">timeOut</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">testOldFibonacci</span><span class="p">(</span><span class="nb">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">long</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">testFibonacci</span><span class="p">(</span><span class="s2">&quot;testFibonacci1&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">fibonacci1</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
        <span class="n">oldFibonacciResults</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">duration</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Test</span><span class="p">(</span><span class="n">dataProvider</span> <span class="o">=</span> <span class="s2">&quot;getFibonacciSize&quot;</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;lambda fibonacci&quot;</span><span class="p">,</span> <span class="n">timeOut</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">testNewFibonacci</span><span class="p">(</span><span class="nb">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">long</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">testFibonacci</span><span class="p">(</span><span class="s2">&quot;testFibonacci2&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">fibonacci2</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
        <span class="n">newFibonacciResults</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">duration</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">long</span> <span class="n">testFibonacci</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="nb">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">func</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Stopwatch</span> <span class="n">stopwatch</span> <span class="o">=</span> <span class="n">Stopwatch</span><span class="o">.</span><span class="n">createStarted</span><span class="p">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
        <span class="n">stopwatch</span><span class="o">.</span><span class="n">stop</span><span class="p">();</span>
        <span class="n">long</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">stopwatch</span><span class="o">.</span><span class="n">elapsed</span><span class="p">(</span><span class="n">TimeUnit</span><span class="o">.</span><span class="n">MICROSECONDS</span><span class="p">);</span>

        <span class="nb">list</span><span class="o">.</span><span class="n">stream</span><span class="p">()</span><span class="o">.</span><span class="n">forEach</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="p">));</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">String</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--&gt; </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">): </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">duration</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">duration</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>做了5组数列长度从10到10000 的测试, 输出结果如下</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span> <span class="n">old</span> <span class="n">vs</span><span class="o">.</span> <span class="n">new</span> <span class="o">---</span>
<span class="mi">10</span><span class="p">:</span> <span class="mi">34</span> <span class="n">vs</span><span class="o">.</span> <span class="mi">28965</span>
<span class="mi">50</span><span class="p">:</span> <span class="mi">9</span> <span class="n">vs</span><span class="o">.</span> <span class="mi">154</span>
<span class="mi">100</span><span class="p">:</span> <span class="mi">13</span> <span class="n">vs</span><span class="o">.</span> <span class="mi">669</span>
<span class="mi">1000</span><span class="p">:</span> <span class="mi">112</span> <span class="n">vs</span><span class="o">.</span> <span class="mi">2600</span>
<span class="mi">10000</span><span class="p">:</span> <span class="mi">1019</span> <span class="n">vs</span><span class="o">.</span> <span class="mi">13548</span>
</pre></div>
</div>
<p>不测不知道, 一测吓一跳, 新的写法看起来不错, 但是性能完败, 关键在于多做了两次转换(map , collect), 这里的测试代码用到了 &#64;BeforeClass, &#64;AfterClass, &#64;Test, &#64;DataProvider, TestNG 还有一些不错的功能, 比如 &#64;threadPoolSize, &#64;expectedExceptions, 详情参见 http://testng.org/doc/documentation-main.html</p>
<p>不知道你发现没有, 这里有个大问题, 这段测试代码缺少 Assert, 多数情况下对于功能测试必需要有 assert , 这些 assert 就是检查点, 没有检查点的测试起不到真正的作用. 你不可能去看每个测试的输出, 当然这里说的是单元测试,而对于性能测试, 一般要出一个性能测试的报告, Assert 检查点也不是必需的</p>
<p>所以我们应该这样写, 尽量多地加断言, 例如我们对 google 的 libphonenumber 作一个简单的测试</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">walterfan</span><span class="o">.</span><span class="n">devaid</span><span class="o">.</span><span class="n">util</span><span class="p">;</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">com.google.i18n.phonenumbers.NumberParseException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.google.i18n.phonenumbers.PhoneNumberUtil</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.google.i18n.phonenumbers.Phonenumber</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.testng.annotations.Test</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="n">testng</span><span class="o">.</span><span class="n">Assert</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="n">testng</span><span class="o">.</span><span class="n">Assert</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="n">testng</span><span class="o">.</span><span class="n">Assert</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="n">testng</span><span class="o">.</span><span class="n">Assert</span><span class="o">.</span><span class="n">fail</span><span class="p">;</span>

<span class="nd">@Slf4j</span>
<span class="n">public</span> <span class="k">class</span><span class="w"> </span><span class="nc">PhoneNumberUtilTest</span> <span class="p">{</span>

    <span class="nd">@Test</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">testIsNumberNsnMatch</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">phoneNumberOne</span> <span class="o">=</span> <span class="s2">&quot;+86055112345678&quot;</span><span class="p">;</span>
        <span class="n">String</span> <span class="n">phoneNumberTwo</span> <span class="o">=</span> <span class="s2">&quot;86055112345678&quot;</span><span class="p">;</span>
        <span class="n">PhoneNumberUtil</span><span class="o">.</span><span class="n">MatchType</span> <span class="n">matchType</span> <span class="o">=</span> <span class="n">PhoneNumberUtil</span><span class="o">.</span><span class="n">getInstance</span><span class="p">()</span><span class="o">.</span><span class="n">isNumberMatch</span><span class="p">(</span><span class="n">phoneNumberOne</span><span class="p">,</span> <span class="n">phoneNumberTwo</span><span class="p">);</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;matchType is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">matchType</span><span class="p">);</span>
        <span class="n">assertFalse</span><span class="p">(</span><span class="n">matchType</span> <span class="o">==</span> <span class="n">PhoneNumberUtil</span><span class="o">.</span><span class="n">MatchType</span><span class="o">.</span><span class="n">NO_MATCH</span><span class="p">);</span>
        <span class="n">assertFalse</span><span class="p">(</span><span class="n">matchType</span> <span class="o">==</span> <span class="n">PhoneNumberUtil</span><span class="o">.</span><span class="n">MatchType</span><span class="o">.</span><span class="n">NOT_A_NUMBER</span><span class="p">);</span>
        <span class="n">assertEquals</span><span class="p">(</span><span class="n">matchType</span> <span class="p">,</span> <span class="n">PhoneNumberUtil</span><span class="o">.</span><span class="n">MatchType</span><span class="o">.</span><span class="n">NSN_MATCH</span><span class="p">);</span>



    <span class="p">}</span>


    <span class="nd">@Test</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">testIsNumberShortMatch</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">phoneNumberOne</span> <span class="o">=</span> <span class="s2">&quot;+86055112345678&quot;</span><span class="p">;</span>
        <span class="n">String</span> <span class="n">phoneNumberTwo</span> <span class="o">=</span> <span class="s2">&quot;086(0551)1234-5678&quot;</span><span class="p">;</span>
        <span class="n">PhoneNumberUtil</span><span class="o">.</span><span class="n">MatchType</span> <span class="n">matchType</span> <span class="o">=</span> <span class="n">PhoneNumberUtil</span><span class="o">.</span><span class="n">getInstance</span><span class="p">()</span><span class="o">.</span><span class="n">isNumberMatch</span><span class="p">(</span><span class="n">phoneNumberOne</span><span class="p">,</span> <span class="n">phoneNumberTwo</span><span class="p">);</span>
        <span class="n">assertFalse</span><span class="p">(</span><span class="n">matchType</span> <span class="o">==</span> <span class="n">PhoneNumberUtil</span><span class="o">.</span><span class="n">MatchType</span><span class="o">.</span><span class="n">NO_MATCH</span><span class="p">);</span>
        <span class="n">assertFalse</span><span class="p">(</span><span class="n">matchType</span> <span class="o">==</span> <span class="n">PhoneNumberUtil</span><span class="o">.</span><span class="n">MatchType</span><span class="o">.</span><span class="n">NOT_A_NUMBER</span><span class="p">);</span>
        <span class="n">assertEquals</span><span class="p">(</span><span class="n">matchType</span> <span class="p">,</span> <span class="n">PhoneNumberUtil</span><span class="o">.</span><span class="n">MatchType</span><span class="o">.</span><span class="n">SHORT_NSN_MATCH</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">testGetCountryCode</span><span class="p">()</span> <span class="p">{</span>

        <span class="n">String</span> <span class="n">strPhoneNumber</span> <span class="o">=</span> <span class="s2">&quot;+86-0551-12345678&quot;</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">Phonenumber</span><span class="o">.</span><span class="n">PhoneNumber</span> <span class="n">phoneNumber</span> <span class="o">=</span> <span class="n">PhoneNumberUtil</span><span class="o">.</span><span class="n">getInstance</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">strPhoneNumber</span><span class="p">,</span> <span class="s2">&quot;US&quot;</span><span class="p">);</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;phoneNumber.getCountryCode() is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">phoneNumber</span><span class="o">.</span><span class="n">getCountryCode</span><span class="p">());</span>
            <span class="n">assertTrue</span><span class="p">(</span><span class="n">phoneNumber</span><span class="o">.</span><span class="n">getCountryCode</span><span class="p">()</span> <span class="o">==</span> <span class="mi">86</span><span class="p">);</span>
        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">NumberParseException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="p">());</span>
        <span class="p">}</span>


    <span class="p">}</span>
<span class="p">}</span>

</pre></div>
</div>
</section>
<section id="id4">
<h3>数据驱动测试<a class="headerlink" href="#id4" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>举例如下, 被测试类为 HttpUtil</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="k">class</span><span class="w"> </span><span class="nc">HttpUtil</span>
<span class="p">{</span>
    <span class="n">public</span> <span class="n">static</span> <span class="n">boolean</span> <span class="n">hasFieldValue</span><span class="p">(</span><span class="n">String</span> <span class="n">httpHeader</span><span class="p">,</span> <span class="n">String</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">String</span> <span class="n">fieldVal</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">null</span> <span class="o">==</span> <span class="n">httpHeader</span> <span class="o">||</span> <span class="n">null</span> <span class="o">==</span> <span class="n">fieldKey</span> <span class="o">||</span> <span class="n">null</span> <span class="o">==</span> <span class="n">fieldVal</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">String</span><span class="p">[]</span> <span class="n">toggles</span> <span class="o">=</span> <span class="n">httpHeader</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">);</span>
		<span class="k">for</span><span class="p">(</span><span class="n">String</span> <span class="n">toggle</span><span class="p">:</span> <span class="n">toggles</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">String</span><span class="p">[]</span> <span class="n">toggleKeyVal</span> <span class="o">=</span> <span class="n">toggle</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">toggleKeyVal</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">toggleKeyVal</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">String</span> <span class="n">val</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">toggleKeyVal</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

				<span class="k">if</span><span class="p">(</span><span class="n">fieldKey</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">fieldVal</span><span class="o">.</span><span class="n">equalsIgnoreCase</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>  <span class="p">{</span>
					<span class="k">return</span> <span class="n">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">false</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>我们会用多个不同的 HTTP 头域来测试这个待测方法是否可正确地把相应头域的值判断出来, 用到的测试数据不必手工构造, 可以放在一个在 Object[][]为返回结果的方法中返回, 这些数据会逐个喂给测试方法, 决窍在于这个注解: <code class="docutils literal notranslate"><span class="pre">&#64;Test(dataProvider=</span> <span class="pre">&quot;makeHttpHeadFields&quot;)</span></code></p></li>
</ul>
<p>所以我们的一个测试方法最终 会生成 8 个测试用例</p>
<p>具体代码如下</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="k">class</span><span class="w"> </span><span class="nc">HttpUtilTest</span> <span class="p">{</span>

    <span class="nd">@DataProvider</span>
    <span class="n">public</span> <span class="n">Object</span><span class="p">[][]</span> <span class="n">makeHttpHeadFields</span><span class="p">()</span> <span class="p">{</span>

        <span class="k">return</span> <span class="n">new</span> <span class="n">Object</span><span class="p">[][]</span> <span class="p">{</span>
                <span class="p">{</span> <span class="s2">&quot;acl_enabled= true&quot;</span><span class="p">,</span> <span class="n">true</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot;acl_enabled=true; auth_type=oauth&quot;</span><span class="p">,</span> <span class="n">true</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot;acl_enabled =TRue; auth_type=basic&quot;</span><span class="p">,</span> <span class="n">true</span>  <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot;acl_enabled = false; auth_type=basic&quot;</span><span class="p">,</span> <span class="n">false</span>  <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot; acl_enabled = ; auth_type=basic&quot;</span><span class="p">,</span> <span class="n">false</span>  <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot;auth_type=basic&quot;</span><span class="p">,</span> <span class="n">false</span>  <span class="p">},</span>
                <span class="p">{</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">false</span>  <span class="p">}</span>

        <span class="p">};</span>


    <span class="p">}</span>

    <span class="nd">@Test</span><span class="p">(</span><span class="n">dataProvider</span><span class="o">=</span> <span class="s2">&quot;makeHttpHeadFields&quot;</span><span class="p">)</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">testHasFieldValue</span><span class="p">(</span><span class="n">String</span> <span class="n">toggleHeader</span><span class="p">,</span> <span class="n">boolean</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Assert</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">HttpUtil</span><span class="o">.</span><span class="n">hasFieldValue</span><span class="p">(</span><span class="n">toggleHeader</span><span class="p">,</span> <span class="s2">&quot;acl_enabled&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> <span class="p">,</span><span class="n">ret</span><span class="p">);</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>运行结果如下</p>
<p><img alt="Test Results" src="http://upload-images.jianshu.io/upload_images/1598924-9b8f17873d0d4f46.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" /></p>
<p>对于单元测试的测试用例组织主要是要逻辑分支覆盖, 符合 <a class="reference external" href="https://www.jianshu.com/p/d84dcb2887f1">微服务实战测试之理论篇</a> 中所提到的三大原则</p>
<ul class="simple">
<li><p>FIRST 原则</p></li>
<li><p>Right-BICEP</p></li>
<li><p>CORRECT 检查原则</p></li>
</ul>
<p>还有很多线程测试, 性能测试, 压力测试, 异常测试, API 测试, 以及消费者契约测试,
这些测试我们后面慢慢道来, Mock 和 API 测试可参见 <a class="reference external" href="https://www.jianshu.com/p/0f17bd2410e4">微服务实战之Mock</a></p>
<p>下面我们就之前提到的测试用例的组织编写一个 TestCase 注解和它的注解处理器, 可在很方便地生成测试用例文档</p>
</section>
</section>
<section id="id5">
<h2>编写注解来自动生成测试用例<a class="headerlink" href="#id5" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">walterfan</span><span class="o">.</span><span class="n">hello</span><span class="o">.</span><span class="n">annotation</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.ElementType</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.Retention</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.RetentionPolicy</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.Target</span><span class="p">;</span>


<span class="nd">@Target</span><span class="p">(</span><span class="n">ElementType</span><span class="o">.</span><span class="n">METHOD</span><span class="p">)</span>
<span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="n">SOURCE</span><span class="p">)</span>
<span class="n">public</span> <span class="nd">@interface</span> <span class="n">TestCase</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">value</span><span class="p">();</span>
    <span class="n">String</span> <span class="n">feature</span><span class="p">()</span> <span class="n">default</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">scenario</span><span class="p">()</span> <span class="n">default</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">given</span><span class="p">()</span> <span class="n">default</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">when</span><span class="p">()</span> <span class="n">default</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">then</span><span class="p">()</span> <span class="n">default</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="o">//</span><span class="n">String</span><span class="p">[]</span> <span class="n">checkpoints</span><span class="p">();</span>
<span class="p">}</span>


</pre></div>
</div>
<p>在编译阶段处理注解并生成测试用例文档</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>package com.github.walterfan.hello.annotation;


import com.google.auto.service.AutoService;

import javax.annotation.processing.AbstractProcessor;
import javax.annotation.processing.ProcessingEnvironment;
import javax.annotation.processing.Processor;
import javax.annotation.processing.RoundEnvironment;
import javax.annotation.processing.SupportedAnnotationTypes;
import javax.annotation.processing.SupportedSourceVersion;
import javax.lang.model.SourceVersion;
import javax.lang.model.element.Element;
import javax.lang.model.element.TypeElement;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.util.Set;
import java.util.concurrent.atomic.AtomicInteger;


@SupportedSourceVersion(SourceVersion.RELEASE_8)
@SupportedAnnotationTypes(&quot;com.github.walterfan.hello.annotation.TestCase&quot;)
@AutoService(Processor.class)
public class TestCaseProcessor extends AbstractProcessor {
    public final static String TABLE_TITLE1 = &quot;| ## | feature | case | scenario | given | when | then |\n&quot;;
    public final static String TABLE_TITLE2 = &quot;|---|---|---|---|---|---|---|\n&quot;;
    public final static String TABLE_ROW = &quot;| %d | %s | %s | %s | %s | %s | %s |\n&quot;;

    private File testcaseFile = new File(&quot;./TestCases.md&quot;);
    private StringBuilder testcaseBuilder = new StringBuilder();
    private AtomicInteger testCaseNum = new AtomicInteger(0);

    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    public synchronized void init(ProcessingEnvironment processingEnv) {
        super.init(processingEnv);

        testcaseBuilder.append(&quot;## Testcases&quot;);
        testcaseBuilder.append(&quot;\n&quot;);
        testcaseBuilder.append(TABLE_TITLE1);
        testcaseBuilder.append(TABLE_TITLE2);
        try (BufferedWriter bw = new BufferedWriter(new FileWriter(testcaseFile))) {
            bw.write(testcaseBuilder.toString());
            bw.flush();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    public boolean process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnvironment) {
        StringBuilder sb = new StringBuilder();
        for (TypeElement annotation : annotations) {

            for (Element element : roundEnvironment.getElementsAnnotatedWith(annotation)) {

                TestCase testCase = element.getAnnotation(TestCase.class);

                if (testCase != null) {
                    String line = String.format(TABLE_ROW, testCaseNum.incrementAndGet(), testCase.feature(), testCase.value(), testCase.scenario(), testCase.given(), testCase.when(), testCase.then());
                    sb.append(line);

                }
            }
        }

        try (BufferedWriter bw = new BufferedWriter(new FileWriter(testcaseFile, true))) {
            bw.write(sb.toString());
            System.out.println(&quot;testcases:\n&quot; + sb.toString());
            bw.flush();
        } catch (IOException e) {
            e.printStackTrace();
        }
        return true;
    }
}

</pre></div>
</div>
<p>假设我们有一个简单的类 User</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">walterfan</span><span class="o">.</span><span class="n">hello</span><span class="o">.</span><span class="n">annotation</span><span class="p">;</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Data</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Calendar</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Date</span><span class="p">;</span>


<span class="nd">@Data</span>
<span class="n">public</span> <span class="k">class</span><span class="w"> </span><span class="nc">User</span> <span class="p">{</span>
    <span class="n">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">String</span> <span class="n">email</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">Date</span> <span class="n">birthDay</span><span class="p">;</span>


    <span class="n">public</span> <span class="nb">int</span> <span class="n">age</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Calendar</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Calendar</span><span class="o">.</span><span class="n">getInstance</span><span class="p">();</span>
        <span class="n">now</span><span class="o">.</span><span class="n">setTime</span><span class="p">(</span><span class="n">new</span> <span class="n">Date</span><span class="p">());</span>

        <span class="n">Calendar</span> <span class="n">birth</span> <span class="o">=</span> <span class="n">Calendar</span><span class="o">.</span><span class="n">getInstance</span><span class="p">();</span>
        <span class="n">birth</span><span class="o">.</span><span class="n">setTime</span><span class="p">(</span><span class="n">birthDay</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">Math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Calendar</span><span class="o">.</span><span class="n">YEAR</span><span class="p">)</span> <span class="o">-</span> <span class="n">birth</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Calendar</span><span class="o">.</span><span class="n">YEAR</span><span class="p">));</span>
    <span class="p">}</span>

<span class="p">}</span>

</pre></div>
</div>
<p>我们写一个测试类</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">walterfan</span><span class="o">.</span><span class="n">hello</span><span class="o">.</span><span class="n">annotation</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.github.walterfan.hello.annotation.User</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.testng.annotations.Test</span><span class="p">;</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">java.text.ParseException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.text.SimpleDateFormat</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Calendar</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Date</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="n">testng</span><span class="o">.</span><span class="n">Assert</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">;</span>


<span class="n">public</span> <span class="k">class</span><span class="w"> </span><span class="nc">UserTest</span> <span class="p">{</span>

    <span class="nd">@Test</span>
    <span class="nd">@TestCase</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;testAge&quot;</span><span class="p">,</span> <span class="n">feature</span> <span class="o">=</span> <span class="s2">&quot;UserManage&quot;</span><span class="p">,</span> <span class="n">scenario</span> <span class="o">=</span> <span class="s2">&quot;CreateUser&quot;</span> <span class="p">,</span><span class="n">given</span> <span class="o">=</span> <span class="s2">&quot;setBirthday&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;retrieveAge&quot;</span><span class="p">,</span> <span class="n">then</span> <span class="o">=</span> <span class="s2">&quot;Age is current time minus birthday&quot;</span><span class="p">)</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">testAge</span><span class="p">()</span> <span class="n">throws</span> <span class="n">ParseException</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">new</span> <span class="n">User</span><span class="p">();</span>
        <span class="n">SimpleDateFormat</span> <span class="n">formatter</span> <span class="o">=</span> <span class="n">new</span> <span class="n">SimpleDateFormat</span><span class="p">(</span><span class="s2">&quot;yyyy/MM/dd&quot;</span><span class="p">);</span>
        <span class="n">Date</span> <span class="n">birthDay</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;1980/02/10&quot;</span><span class="p">);</span>
        <span class="n">user</span><span class="o">.</span><span class="n">setBirthDay</span><span class="p">(</span><span class="n">birthDay</span><span class="p">);</span>

        <span class="n">Calendar</span> <span class="n">birthCal</span> <span class="o">=</span> <span class="n">Calendar</span><span class="o">.</span><span class="n">getInstance</span><span class="p">();</span>
        <span class="n">birthCal</span><span class="o">.</span><span class="n">setTime</span><span class="p">(</span><span class="n">birthDay</span><span class="p">);</span>

        <span class="nb">int</span> <span class="n">diffYear</span> <span class="o">=</span> <span class="n">Calendar</span><span class="o">.</span><span class="n">getInstance</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Calendar</span><span class="o">.</span><span class="n">YEAR</span><span class="p">)</span> <span class="o">-</span> <span class="n">birthCal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Calendar</span><span class="o">.</span><span class="n">YEAR</span><span class="p">);</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;diffYear: &quot;</span><span class="o">+</span> <span class="n">diffYear</span><span class="p">);</span>
        <span class="n">assertEquals</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">age</span><span class="p">(),</span> <span class="n">diffYear</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="nd">@TestCase</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;testName&quot;</span><span class="p">,</span> <span class="n">feature</span> <span class="o">=</span> <span class="s2">&quot;UserManage&quot;</span><span class="p">,</span> <span class="n">scenario</span> <span class="o">=</span> <span class="s2">&quot;UpdateUser&quot;</span> <span class="p">,</span><span class="n">given</span> <span class="o">=</span> <span class="s2">&quot;setName&quot;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;retrieveName&quot;</span><span class="p">,</span> <span class="n">then</span> <span class="o">=</span> <span class="s2">&quot;name is same&quot;</span><span class="p">)</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">testName</span><span class="p">()</span> <span class="n">throws</span> <span class="n">ParseException</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Walter&quot;</span><span class="p">;</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">new</span> <span class="n">User</span><span class="p">();</span>
        <span class="n">user</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
        <span class="n">user</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></div>
</div>
<p>编译这个类会自动生成一个 TestCase.md, 内容如下</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">Testcases</span>
<span class="o">|</span> <span class="c1">## | feature | case | scenario | given | when | then |</span>
<span class="o">|---|---|---|---|---|---|---|</span>
<span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">UserManage</span> <span class="o">|</span> <span class="n">testAge</span> <span class="o">|</span> <span class="n">CreateUser</span> <span class="o">|</span> <span class="n">setBirthday</span> <span class="o">|</span> <span class="n">retrieveAge</span> <span class="o">|</span> <span class="n">Age</span> <span class="ow">is</span> <span class="n">current</span> <span class="n">time</span> <span class="n">minus</span> <span class="n">birthday</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">UserManage</span> <span class="o">|</span> <span class="n">testName</span> <span class="o">|</span> <span class="n">UpdateUser</span> <span class="o">|</span> <span class="n">setName</span> <span class="o">|</span> <span class="n">retrieveName</span> <span class="o">|</span> <span class="n">name</span> <span class="ow">is</span> <span class="n">same</span> <span class="o">|</span>
</pre></div>
</div>
<p>也就是</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>##</p></th>
<th class="head"><p>feature</p></th>
<th class="head"><p>case</p></th>
<th class="head"><p>scenario</p></th>
<th class="head"><p>given</p></th>
<th class="head"><p>when</p></th>
<th class="head"><p>then</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>UserManage</p></td>
<td><p>testAge</p></td>
<td><p>CreateUser</p></td>
<td><p>setBirthday</p></td>
<td><p>retrieveAge</p></td>
<td><p>Age is current time minus birthday</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>UserManage</p></td>
<td><p>testName</p></td>
<td><p>UpdateUser</p></td>
<td><p>setName</p></td>
<td><p>retrieveName</p></td>
<td><p>name is same</p></td>
</tr>
</tbody>
</table>
<p>完整代码可参见 https://github.com/walterfan/helloworld/tree/master/helloannotation</p>
</section>
<section id="id6">
<h2>参考资料<a class="headerlink" href="#id6" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="http://testng.org/doc/documentation-main.html">TestNG 官方文档</a></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="test_mock.html" class="btn btn-neutral float-left" title="Test Mock" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../4.devops/index.html" class="btn btn-neutral float-right" title="4. Agile DevOps" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021 ~ 2035, Walter Fan, Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>